<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/12082/12082876.png">
    <title>Steins;Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/background.css">
    <script type="module" src="assets/js/background.js" defer></script>
    <link rel="stylesheet" href="assets/css/music-player.css">
    <script src="assets/js/music-player.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --primary: #00ff88;
            --primary-dark: #00cc6a;
            --background: #0f172a;
            --card-bg: #1e293be9;
            --text: #f8fafc;
            --text-secondary: #94a3b8;
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding: 6rem;
            margin-top: -20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), #00b7ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-weight: 400;
            font-size: 1rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
            background-color: #1e293b91;
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
        }

        .btn {
            background-color: var(--primary);
            border: none;
            color: #000;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 255, 136, 0.1);
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 255, 136, 0.2);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: rgba(0, 255, 136, 0.1);
        }

        select {
            background-color: var(--card-bg);
            border: 2px solid #334155;
            color: var(--text);
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            min-width: 180px;
        }

        select:hover {
            border-color: var(--primary);
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.3);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid #334155;
            text-align: center;
        }

        .summary-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0.5rem 0;
        }

        .summary-card-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .game-list {
            width: 100%;
            margin-bottom: 2rem;
        }

        .game-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .game-table th,
        .game-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #334155;
        }

        .game-table th {
            background-color: #1a2539;
            color: var(--primary);
            font-weight: 600;
        }

        .game-table tr:last-child td {
            border-bottom: none;
        }

        .game-table tr:hover {
            background-color: #2a374b;
        }

        .game-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }

        .game-name {
            display: inline-flex;
            align-items: center;
        }

        .progress-container {
            width: 100%;
            background-color: #334155;
            border-radius: 10px;
            height: 10px;
            margin-top: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            background-color: var(--primary);
            transition: width 0.3s ease;
        }

        .game-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .game-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid #334155;
            backdrop-filter: blur(10px);
        }

        .game-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .game-card-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .game-card-title {
            font-weight: 600;
        }

        .game-card-stats {
            margin-top: 1rem;
        }

        .game-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .game-stat-label {
            color: var(--text-secondary);
        }

        .game-stat-value {
            font-weight: 500;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
            border: 1px solid #334155;
        }

        .card2 {
            background: #1e293b3d;
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
            border: 1px solid #334155;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-wide {
            grid-column: 1 / -1;
        }

        canvas {
            width: 100% !important;
            height: 300px !important;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 2rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .game-table {
                display: block;
                overflow-x: auto;
            }
        }

        /* Heatmap Styles */
        #heatmap-container {
            padding: 1rem;
            font-size: 0.85rem;
            overflow-x: auto;
        }

        .heatmap-header {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
            color: var(--text);
            font-weight: 500;
        }

        .heatmap-grid {
            display: flex;
            gap: 4px;
        }

        .heatmap-days {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-right: 8px;
            color: var(--text-secondary);
            justify-content: space-between;
            padding-top: 22px;
            font-size: 0.8rem;
        }

        #heatmap-cells {
            display: grid;
            grid-template-columns: repeat(53, 1fr);
            grid-auto-rows: 16px;
            gap: 4px;
            min-width: 900px;
        }

        .heatmap-cell {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .heatmap-cell:hover {
            transform: scale(1.3);
            box-shadow: 0 0 0 2px var(--primary);
            z-index: 2;
        }

        .heatmap-cell:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            color: var(--text);
            padding: 5px 10px;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            white-space: pre;
            z-index: 3;
            border: 1px solid var(--primary);
            pointer-events: none;
        }

        .heatmap-legend {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .legend-colors {
            display: flex;
            gap: 4px;
        }

        .color-box {
            width: 14px;
            height: 14px;
            border-radius: 2px;
        }

        /* SCROLLBAR PERSONALIZADA */
        ::-webkit-scrollbar {
            width: 10px;
            /* Largura da scrollbar vertical */
            height: 10px;
            /* Altura da scrollbar horizontal */
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
            /* Cor do track (fundo) - combinando com --card-bg */
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: #00cc6a;
            /* Cor do thumb (alça) - combinando com --primary-dark */
            border-radius: 5px;
            border: 2px solid #1e293b;
            /* Borda para contraste */
            transition: all 0.3s ease;
            /* Transição suave */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00ff88;
            /* Cor ao passar o mouse - combinando com --primary */
            cursor: grab;
            /* Cursor indicando que pode arrastar */
        }

        ::-webkit-scrollbar-thumb:active {
            background: #00a05c;
            /* Cor quando clicado */
            cursor: grabbing;
            /* Cursor de arrastando */
        }

        /* Para Firefox */
        html {
            scrollbar-width: thin;
            /* "auto" ou "thin" */
            scrollbar-color: #00cc6a #1e293b;
            /* thumb e track */
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #00ff88e4;
            color: rgb(0, 0, 0);
            border: none;
            cursor: pointer;
            text-decoration: none;
            margin-right: 10px;
            transition: background-color 0.3s;
            backdrop-filter: blur(10px);
        }

        .icon-btn:hover {
            background-color: #fefefe6f;
            backdrop-filter: blur(8px);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
        }

        #periodo {
            padding: 8px 12px;
            border-radius: 20px;
            margin-right: 10px;
        }

        /* Botão */
        .dropbtn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 10px 16px;
            font-size: 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }

        .dropbtn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.03);
        }

        /* Container dropdown */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        /* Conteúdo dropdown */
        .dropdown-content {
            display: none;
            position: absolute;
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            min-width: 160px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            z-index: 1;
            overflow: hidden;
        }

        .dropdown-content a {
            color: #fff;
            padding: 10px 14px;
            text-decoration: none;
            display: block;
            transition: background 0.2s;
        }

        .dropdown-content a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Mostrar dropdown no hover */
        .dropdown:hover .dropdown-content {
            display: block;
        }

        .subtitle {
            transition: opacity 0.5s ease-in-out;
        }

        .summary-card {
            position: relative;
        }

        .summary-card-subvalue {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="dashboard-header">
            <h1>Steins;Tracker</h1>
            <p class="subtitle" id="slogan">Visualize suas estatísticas de jogo</p>
        </div>
    </div>

    <div class="controls">
        <!-- Ícone redondo para página inicial -->
        <a href="/index.html" class="icon-btn" title="Página Inicial">
            <i class="fas fa-home"></i>
        </a>

        <!-- Ícone redondo para selecionar jogos -->
        <a href="/seletor-de-jogos.html" class="icon-btn" title="Selecionar Jogos">
            <i class="fas fa-check-double"></i>
        </a>

        <!-- Ícone redondo para backgrounds -->
        <a href="/backgrounds.html" class="icon-btn" title="Backgrounds">
            <i class="fas fa-image"></i>
        </a>

        <!-- Ícone redondo para GM -->
        <a href="/gamer-monitor.html" class="icon-btn" title="Gamer Monitor">
            <i class="fas fa-gamepad"></i>
        </a>

        <!-- Ícone redondo para Icones -->
        <a href="/icons-save.html" class="icon-btn" title="Icons">
            <i class="fas fa-icons"></i>
        </a>

        <!-- Dropdown de período -->
        <select id="periodo" aria-label="Filtrar período" title="Filtrar período">
            <option value="todos">Todos os registros</option>
            <option value="30">Últimos 30 dias</option>
            <option value="7">Últimos 7 dias</option>
        </select>

        <!-- Ícone redondo para exportar -->
        <button class="icon-btn" id="btnExportar" title="Exportar CSV">
            <i class="fas fa-file-export"></i>
        </button>
    </div>

    <!-- Cards de Resumo -->
    <div class="summary-cards">
        <div class="summary-card">
            <div class="summary-card-label">Tempo Total</div>
            <div class="summary-card-value" id="totalTempo">0h 0min</div>
            <div class="summary-card-subvalue" id="totalTempoDetail"></div>
        </div>
        <div class="summary-card">
            <div class="summary-card-label">Jogos Monitorados</div>
            <div class="summary-card-value" id="totalJogos">0</div>
        </div>
        <div class="summary-card">
            <div class="summary-card-label">Média Diária</div>
            <div class="summary-card-value" id="mediaDiaria">0h 0min</div>
        </div>
        <div class="summary-card">
            <div class="summary-card-label">Meta Diária (2h)</div>
            <div class="summary-card-value" id="metaStatus">0%</div>
            <div class="progress-container">
                <div class="progress-bar" id="metaProgresso" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Lista de Jogos -->
    <div class="game-list">
        <h2 style="margin-bottom: 1rem; color: var(--primary);">Seus Jogos</h2>
        <table class="game-table" id="tabelaJogos">
            <thead>
                <tr>
                    <th>Jogo</th>
                    <th>Tempo Jogado</th>
                    <th>Última Vez</th>
                    <th>Sessões</th>
                </tr>
            </thead>
            <tbody id="corpoTabelaJogos">
                <!-- Preenchido dinamicamente -->
            </tbody>
        </table>
    </div>


    <!-- Gráfico de Evolução Diária -->
    <div class="card card-wide">
        <div class="card-header">
            <i class="fas fa-chart-line"></i> Evolução Diária
        </div>
        <canvas id="graficoLinha"></canvas>
    </div>
    <br>
    <!-- Heatmap de Frequência Anual -->
    <div class="card2 card-wide">
        <div class="card-header">
            <i class="fas fa-calendar-alt"></i> Frequência de Jogatina (Ano Atual)
        </div>
        <div id="heatmap-container">
            <div class="heatmap-header">
                <span id="heatmap-period">${new Date().getFullYear()}</span>
            </div>
            <div class="heatmap-grid">
                <div class="heatmap-days">
                    <span>Seg</span>
                    <span>Qua</span>
                    <span>Sex</span>
                </div>
                <div id="heatmap-cells"></div>
            </div>
            <div class="heatmap-legend">
                <span>Menos</span>
                <div class="legend-colors">
                    <div class="color-box" style="background-color: #1e293b;"></div>
                    <div class="color-box" style="background-color: #0f5a3a;"></div>
                    <div class="color-box" style="background-color: #00a05c;"></div>
                    <div class="color-box" style="background-color: #00ff88;"></div>
                </div>
                <span>Mais</span>
            </div>
        </div>
    </div>

    <!-- Cards Individuais de Jogos -->
    <h2 style="margin-top: 2rem; color: var(--primary);">Estatísticas por Jogo</h2>
    <div class="game-cards" id="cardsJogos">
        <!-- Preenchido dinamicamente -->
    </div>
    </div>

    <script>
        let graficoLinha;

        // Mapeamento de ícones para jogos populares
        let gameIcons = {};

        // Função para carregar os ícones do arquivo JSON
        async function loadGameIcons() {
            try {
                const response = await fetch('/api/icons'); // antes era 'data/icons.json'
                if (!response.ok) {
                    throw new Error('Falha ao carregar ícones');
                }
                gameIcons = await response.json();
            } catch (error) {
                console.error('Erro ao carregar ícones:', error);
                gameIcons = {
                    'default': 'https://cdn-icons-png.flaticon.com/512/3652/3652191.png'
                };
            }
        }


        // Função para obter o ícone do jogo
        function getGameIcon(gameName) {
            return gameIcons[gameName] || gameIcons['default'] || 'https://cdn-icons-png.flaticon.com/512/3652/3652191.png';
        }

        // Função para formatar data
        function formatarData(data) {
            const dt = new Date(data);
            return dt.toLocaleDateString('pt-BR', {
                timeZone: 'America/Sao_Paulo',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }


        // Função para formatar tempo
        function formatarTempo(minutos) {
            if (minutos < 60) return `${minutos} min`;

            const horasTotal = minutos / 60;
            const horas = Math.floor(horasTotal);
            const mins = Math.round((horasTotal - horas) * 60);

            if (horas < 24) {
                return `${horas}h ${mins}min`;
            } else {
                const dias = Math.floor(horas / 24);
                const horasRestantes = horas % 24;
                return `${dias}d ${horasRestantes}h`;
            }
        }

        function formatarTempoCompleto(minutos) {
            const horasTotal = minutos / 60;
            const horas = Math.floor(horasTotal);
            const mins = minutos % 60;
            return `${horas}h ${mins}min`;
        }

        function formatarMinutosParaHoras(minutos) {
            const horas = Math.floor(minutos / 60);
            const mins = minutos % 60;
            return `${horas}h ${mins}min`;
        }

        // Função para calcular dias entre datas
        function diasEntreDatas(dataInicial, dataFinal) {
            const diff = new Date(dataFinal) - new Date(dataInicial);
            return Math.ceil(diff / (1000 * 60 * 60 * 24)) || 1;
        }

        async function carregarLogs() {
            try {
                const [logsResponse, selectedResponse, friendlyNamesResponse] = await Promise.all([
                    fetch('/api/logs'),
                    fetch('/api/jogos-selecionados'),
                    fetch('/api/nomes-amigaveis')
                ]);

                const [logs, selected, friendlyNames] = await Promise.all([
                    logsResponse.json(),
                    selectedResponse.json(),
                    friendlyNamesResponse.json()
                ]);

                const selectedSet = new Set(selected);

                // Substitui nomes por nomes amigáveis nos logs
                const filteredLogs = logs
                    .filter(log => selectedSet.has(log.jogo) || friendlyNames[log.jogo])
                    .map(log => {
                        const nomeAmigavel = friendlyNames[log.jogo];
                        const exeOriginal = Object.keys(friendlyNames).find(exe => friendlyNames[exe] === log.jogo);
                        if (nomeAmigavel) {
                            return { ...log, jogo: nomeAmigavel };
                        } else if (exeOriginal && selectedSet.has(exeOriginal)) {
                            return { ...log, jogo: friendlyNames[exeOriginal] };
                        } else {
                            return log;
                        }
                    });

                return filteredLogs;
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
                return [];
            }
        }


        function filtrarPorPeriodo(logs, dias) {
            if (dias === 'todos') return logs;
            const agora = new Date();
            const limite = new Date(agora.getTime() - dias * 24 * 60 * 60 * 1000);
            return logs.filter(log => new Date(log.inicio) >= limite);
        }

        function agruparTempoPorJogo(logs) {
            const mapa = {};
            const contagemSessoes = {};
            const ultimaVez = {};

            logs.forEach(log => {
                if (!mapa[log.jogo]) {
                    mapa[log.jogo] = 0;
                    contagemSessoes[log.jogo] = 0;
                    ultimaVez[log.jogo] = new Date(0);
                }

                mapa[log.jogo] += log.tempoTotalMin;
                contagemSessoes[log.jogo] += 1;

                const dataLog = new Date(log.inicio);
                if (dataLog > ultimaVez[log.jogo]) {
                    ultimaVez[log.jogo] = dataLog;
                }
            });

            return { tempo: mapa, sessoes: contagemSessoes, ultimaVez: ultimaVez };
        }

        function formatarDataISO(data) {
            const date = new Date(data);
            // Ajusta para o fuso horário de Brasília (UTC-3)
            const offset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() - offset);
            return localDate.toISOString().split('T')[0]; // YYYY-MM-DD
        }

        function agruparPorDia(logs) {
            const mapa = {};
            logs.forEach(log => {
                const data = formatarDataISO(log.inicio);
                if (!mapa[data]) mapa[data] = {};
                if (!mapa[data][log.jogo]) mapa[data][log.jogo] = 0;
                mapa[data][log.jogo] += log.tempoTotalMin;
            });
            return mapa;
        }

        function criarDatasContinuas(dias) {
            const datas = [];
            const hoje = new Date();

            // Ajusta para o fuso horário de Brasília
            hoje.setHours(hoje.getHours() - 3);

            for (let i = dias - 1; i >= 0; i--) {
                const dt = new Date(hoje);
                dt.setDate(dt.getDate() - i);
                datas.push(formatarDataISO(dt));
            }
            return datas;
        }

        function prepararDadosLinha(mapa, jogos, datas) {
            const datasets = jogos.map((jogo, i) => {
                return {
                    label: jogo,
                    data: datas.map(d => mapa[d]?.[jogo] || 0),
                    borderColor: `hsl(${(i * 360 / jogos.length)}, 80%, 60%)`,
                    backgroundColor: `hsla(${(i * 360 / jogos.length)}, 80%, 60%, 0.2)`,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    borderWidth: 2,
                    pointBackgroundColor: `hsl(${(i * 360 / jogos.length)}, 80%, 60%)`
                };
            });
            return datasets;
        }

        function atualizarResumo(totalMinutos, totalJogos, logs, periodo) {
            // Tempo Total
            document.getElementById('totalTempo').textContent = formatarTempo(totalMinutos);
            document.getElementById('totalTempoDetail').textContent = `(${formatarTempoCompleto(totalMinutos)} total)`;

            // Jogos Monitorados
            document.getElementById('totalJogos').textContent = totalJogos;

            // Média Diária
            let diasCalculo;
            if (periodo === 'todos') {
                const primeiraData = new Date(logs.reduce((min, log) =>
                    new Date(log.inicio) < min ? new Date(log.inicio) : min, new Date()));
                diasCalculo = diasEntreDatas(primeiraData, new Date());
            } else {
                diasCalculo = parseInt(periodo);
            }
            const mediaDiaria = totalMinutos / diasCalculo;
            document.getElementById('mediaDiaria').textContent = formatarTempo(mediaDiaria);

            // Meta Diária (2h = 120min) - calcula apenas para o dia atual
            const hoje = formatarDataISO(new Date());
            const minutosHoje = logs.reduce((total, log) => {
                const dataLog = formatarDataISO(log.inicio);
                return dataLog === hoje ? total + log.tempoTotalMin : total;
            }, 0);

            const percentualMeta = Math.min(Math.round((minutosHoje / 120) * 100), 100);
            document.getElementById('metaStatus').textContent = `${percentualMeta}%`;
            document.getElementById('metaProgresso').style.width = `${percentualMeta}%`;

            // Barra de progresso colorida
            const progressBar = document.getElementById('metaProgresso');
            progressBar.style.backgroundColor = percentualMeta >= 100 ? '#00ff88' :
                percentualMeta > 50 ? '#00ff88' : '#00ff88';
        }

        function atualizarListaJogos(dadosAgrupados) {
            const corpoTabela = document.getElementById('corpoTabelaJogos');
            corpoTabela.innerHTML = '';

            const jogosOrdenados = Object.keys(dadosAgrupados.tempo).sort((a, b) =>
                dadosAgrupados.tempo[b] - dadosAgrupados.tempo[a]
            );

            jogosOrdenados.forEach(jogo => {
                const linha = document.createElement('tr');

                const tempoFormatado = formatarTempo(dadosAgrupados.tempo[jogo]);
                const ultimaVezFormatada = dadosAgrupados.ultimaVez[jogo] ?
                    formatarData(dadosAgrupados.ultimaVez[jogo]) : 'Nunca';

                linha.innerHTML = `
          <td>
            <div class="game-name">
              <img src="${getGameIcon(jogo)}" class="game-icon" alt="${jogo}">
              ${jogo}
            </div>
          </td>
          <td>${tempoFormatado}</td>
          <td>${ultimaVezFormatada}</td>
          <td>${dadosAgrupados.sessoes[jogo]}</td>
        `;

                corpoTabela.appendChild(linha);
            });
        }

        function atualizarCardsJogos(dadosAgrupados) {
            const container = document.getElementById('cardsJogos');
            container.innerHTML = '';

            const jogosOrdenados = Object.keys(dadosAgrupados.tempo).sort((a, b) =>
                dadosAgrupados.tempo[b] - dadosAgrupados.tempo[a]
            );

            jogosOrdenados.forEach(jogo => {
                const card = document.createElement('div');
                card.className = 'game-card';

                const tempoTotal = dadosAgrupados.tempo[jogo];
                const sessoes = dadosAgrupados.sessoes[jogo];
                const ultimaVez = dadosAgrupados.ultimaVez[jogo];
                const mediaPorSessao = tempoTotal / sessoes;

                card.innerHTML = `
          <div class="game-card-header">
            <img src="${getGameIcon(jogo)}" class="game-card-icon" alt="${jogo}">
            <div class="game-card-title">${jogo}</div>
          </div>
          <div class="game-card-stats">
            <div class="game-stat">
              <span class="game-stat-label">Tempo Total:</span>
              <span class="game-stat-value">${formatarTempo(tempoTotal)}</span>
            </div>
            <div class="game-stat">
              <span class="game-stat-label">Sessões:</span>
              <span class="game-stat-value">${sessoes}</span>
            </div>
            <div class="game-stat">
              <span class="game-stat-label">Média/Sessão:</span>
              <span class="game-stat-value">${formatarTempo(mediaPorSessao)}</span>
            </div>
            <div class="game-stat">
              <span class="game-stat-label">Última vez:</span>
              <span class="game-stat-value">${ultimaVez ? formatarData(ultimaVez) : 'Nunca'}</span>
            </div>
          </div>
        `;

                container.appendChild(card);
            });
        }

        async function gerarGraficos() {
            const periodoSelect = document.getElementById('periodo');
            const periodo = periodoSelect.value;

            let logs = await carregarLogs();
            logs = filtrarPorPeriodo(logs, periodo);

            // Dados para barra e pizza
            const dadosAgrupados = agruparTempoPorJogo(logs);
            const jogos = Object.keys(dadosAgrupados.tempo);
            const tempos = Object.values(dadosAgrupados.tempo);

            const totalMinutos = tempos.reduce((a, b) => a + b, 0);
            atualizarResumo(totalMinutos, jogos.length, logs, periodo);
            atualizarListaJogos(dadosAgrupados);
            atualizarCardsJogos(dadosAgrupados);

            // Gráfico de linha - evolução diária
            const mapaDias = {};
            logs.forEach(log => {
                const data = formatarDataISO(log.inicio); // Já usa fuso correto
                if (!mapaDias[data]) mapaDias[data] = {};
                if (!mapaDias[data][log.jogo]) mapaDias[data][log.jogo] = 0;
                mapaDias[data][log.jogo] += log.tempoTotalMin;
            });
            let datas;
            if (periodo === 'todos') {
                // Para 'todos', cria um range completo desde a primeira data até hoje
                const primeiraData = new Date(logs.reduce((min, log) =>
                    new Date(log.inicio) < min ? new Date(log.inicio) : min, new Date()));
                const dias = diasEntreDatas(primeiraData, new Date());
                datas = criarDatasContinuas(dias);
            } else {
                datas = criarDatasContinuas(parseInt(periodo));
            }
            const datasUltimosDias = periodo === 'todos' ?
                Object.keys(mapaDias).sort() :
                criarDatasContinuas(parseInt(periodo));

            const datasetsLinha = prepararDadosLinha(mapaDias, jogos, datasUltimosDias);

            const ctxLinha = document.getElementById('graficoLinha').getContext('2d');
            if (graficoLinha) graficoLinha.destroy();
            graficoLinha = new Chart(ctxLinha, {
                type: 'line',
                data: {
                    labels: datasUltimosDias,
                    datasets: datasetsLinha
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#f8fafc',
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20
                            }
                        },
                        tooltip: {
                            mode: 'nearest',
                            intersect: false,
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${formatarTempo(ctx.parsed.y)}`,
                                title: (items) => {
                                    return items[0].label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Minutos jogados', color: '#94a3b8' },
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            title: { display: true, text: 'Data', color: '#94a3b8' },
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            gerarHeatmap(logs);
        }

        function exportarCSV() {
            carregarLogs().then(logs => {
                if (!logs.length) {
                    alert('Sem dados para exportar');
                    return;
                }

                const linhas = [
                    ['Jogo', 'Início', 'Fim', 'Duração (min)']
                ];

                logs.forEach(log => {
                    linhas.push([
                        `"${log.jogo}"`,
                        `"${new Date(log.inicio).toLocaleString()}"`,
                        `"${new Date(log.fim).toLocaleString()}"`,
                        log.tempoTotalMin
                    ]);
                });

                const csvContent = linhas.map(e => e.join(';')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'status_gamer_logs.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        document.getElementById('periodo').addEventListener('change', gerarGraficos);
        document.getElementById('btnExportar').addEventListener('click', exportarCSV);

        window.onload = async function () {
            await loadGameIcons();
            gerarGraficos();
        };

        function gerarHeatmap(logs) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const startDate = new Date(currentYear, 0, 1); // 1º de janeiro do ano atual
            const endDate = new Date(currentYear, 11, 31); // 31 de dezembro do ano atual

            // Agrupar por dia
            const dailyStats = {};
            logs.forEach(log => {
                const logDate = new Date(log.inicio);
                if (logDate.getFullYear() === currentYear) {
                    const date = formatarDataISO(log.inicio);
                    if (!dailyStats[date]) dailyStats[date] = 0;
                    dailyStats[date] += log.tempoTotalMin;
                }
            });

            // Criar células organizadas por semanas do ano
            const container = document.getElementById('heatmap-cells');
            container.innerHTML = '';

            // Calcular número de semanas no ano (53 no máximo)
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const weekCount = Math.ceil((endDate - startDate) / msPerWeek) + 1;

            container.style.gridTemplateColumns = `repeat(${weekCount}, 1fr)`;
            document.getElementById('heatmap-period').textContent = currentYear;

            // Preencher células para cada dia da semana (seg a dom) e cada semana do ano
            for (let day = 0; day < 7; day++) {
                for (let week = 0; week < weekCount; week++) {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + (week * 7) + day);

                    // Verificar se a data está dentro do ano atual e não no futuro
                    if (date > endDate || date > now) {
                        const emptyCell = document.createElement('div');
                        emptyCell.className = 'heatmap-cell';
                        emptyCell.style.visibility = 'hidden';
                        container.appendChild(emptyCell);
                        continue;
                    }

                    const dateStr = formatarDataISO(date);
                    const minutes = dailyStats[dateStr] || 0;

                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    cell.setAttribute('data-tooltip', `${date.toLocaleDateString('pt-BR')}\n${formatarTempo(minutes)}`);

                    // Definir cor baseada no tempo jogado
                    if (minutes === 0) {
                        cell.style.backgroundColor = 'var(--card-bg)';
                    } else if (minutes < 30) {
                        cell.style.backgroundColor = '#0f5a3a';
                    } else if (minutes < 120) {
                        cell.style.backgroundColor = '#00a05c';
                    } else {
                        cell.style.backgroundColor = 'var(--primary)';
                    }

                    container.appendChild(cell);
                }
            }
        }
    </script>
    <script>
        const slogans = [
            "Controle o tempo. Rastreie seu destino.",
            "Porque até o tempo pode ser monitorado.",
            "Visualize. Rastreie. Diverja.",
            "Seus jogos. Suas linhas do tempo.",
            "Steins;Tracker — Reading Steiner ativado.",
            "Cada partida conta. Em qualquer linha temporal.",
            "Rastreie seu passado para dominar o futuro.",
            "Onde os jogos seguem suas próprias worldlines.",
            "O futuro é gravado. Estatísticas também.",
            "Steins;Tracker — Porque o tempo de jogo também importa."
        ];

        const sloganEl = document.getElementById('slogan');

        function trocarSlogan() {
            const novo = slogans[Math.floor(Math.random() * slogans.length)];
            // efeito de fade
            sloganEl.style.opacity = 0;
            setTimeout(() => {
                sloganEl.textContent = novo;
                sloganEl.style.opacity = 1;
            }, 500);
        }

        // Troca na primeira carga
        trocarSlogan();

        // Troca a cada 30 segundos
        setInterval(trocarSlogan, 30000);
    </script>
    <script>
        const { ipcRenderer } = require('electron');

        ipcRenderer.on('update_available', () => {
            alert('Uma nova atualização está disponível. Baixando...');
        });

        ipcRenderer.on('update_downloaded', () => {
            const shouldUpdate = confirm('Atualização pronta. Deseja reiniciar e aplicar?');
            if (shouldUpdate) {
                ipcRenderer.send('restart_app');
            }
        });

    </script>

</body>

</html>
